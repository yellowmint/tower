# tower/infra

## Prerequisites

- [Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)
- [Cloud SDK](https://cloud.google.com/sdk/docs/install)

Authenticate

```shell
gcloud auth application-default login
```

Docker repository

```shell
gcloud auth configure-docker us-central1-docker.pkg.dev
```

## Manual config
Before `terraform apply` those steps need to be taken:
1. Enable billing in GCP project
2. Configure DNS 
   1. Every url generated by this config needs a CNAME pointing to `ghs.googlehosted.com.`.
3. Enable Firestore API - https://console.cloud.google.com/apis/library/firestore.googleapis.com?project=<projekct-id>
4. Create Firestore database - https://console.cloud.google.com/datastore/setup?project=<projekct-id>

## Deployment

1. Upload image from JetBrains Space to Google Cloud Platform
    ```shell
    make push_image img=be-rpcpublic tag=0.0.1-main-build-2
    ```
2. Update image tag in config file `./main.tf`
3. Apply changes in cloud
    ```shell
    terraform apply
    ```
